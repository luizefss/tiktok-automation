#!/usr/bin/env python3
# /var/www/tiktok-automation/backend/test_enhanced_tts.py

"""
Script de teste para o Google Cloud TTS Enhanced
Demonstra todas as funcionalidades baseadas na documentaÃ§Ã£o oficial
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from google_ai_studio_tts_enhanced import GoogleAIStudioTTSEnhanced
import json

def test_voice_listing():
    """Testa listagem de vozes disponÃ­veis"""
    print("ğŸ” Testando listagem de vozes...")
    
    tts = GoogleAIStudioTTSEnhanced()
    voices = tts.list_available_voices()
    
    print(f"âœ… Encontradas {len(voices)} vozes para pt-BR:")
    for voice in voices[:5]:  # Mostra apenas as primeiras 5
        print(f"   - {voice['name']} ({voice['ssml_gender']})")
    
    return len(voices) > 0

def test_emotion_analysis():
    """Testa anÃ¡lise avanÃ§ada de emoÃ§Ãµes"""
    print("\nğŸ§  Testando anÃ¡lise de emoÃ§Ãµes...")
    
    tts = GoogleAIStudioTTSEnhanced()
    
    test_texts = [
        "Que histÃ³ria incrÃ­vel e emocionante!",
        "Algo estranho aconteceu naquela noite escura...",
        "Estou muito feliz com este resultado!",
        "Vamos descobrir juntos este mistÃ©rio fascinante."
    ]
    
    for text in test_texts:
        emotions = tts.analyze_text_emotions_advanced(text)
        print(f"   Texto: '{text[:30]}...'")
        for segment, emotion, intensity in emotions:
            print(f"     â†’ EmoÃ§Ã£o: {emotion} (intensidade: {intensity:.1f})")
    
    return True

def test_voice_recommendation():
    """Testa recomendaÃ§Ã£o de voz"""
    print("\nğŸ¯ Testando recomendaÃ§Ã£o de voz...")
    
    tts = GoogleAIStudioTTSEnhanced()
    
    test_cases = [
        ("Bem-vindos ao nosso canal educativo sobre ciÃªncia!", "estudantes"),
        ("Descubra os segredos mais profundos deste mistÃ©rio...", "adultos"),
        ("OlÃ¡ crianÃ§as! Vamos aprender brincando!", "crianÃ§as"),
        ("Apresento os resultados do nosso relatÃ³rio trimestral.", "profissionais")
    ]
    
    for text, audience in test_cases:
        voice = tts.get_voice_recommendation(text, audience)
        voice_name = tts.voice_mapping.get(voice, 'N/A')
        print(f"   AudiÃªncia: {audience}")
        print(f"   Voz recomendada: {voice} ({voice_name})")
    
    return True

def test_basic_synthesis():
    """Testa sÃ­ntese bÃ¡sica com diferentes emoÃ§Ãµes"""
    print("\nğŸµ Testando sÃ­ntese bÃ¡sica...")
    
    tts = GoogleAIStudioTTSEnhanced()
    
    test_cases = [
        ("OlÃ¡! Este Ã© um teste da nossa nova tecnologia de voz.", "neutral", "neural-female-natural"),
        ("Que descoberta extraordinÃ¡ria e emocionante!", "enthusiastic", "premium-female-energetic"),
        ("Nas sombras da noite, algo misterioso se aproxima...", "mysterious", "premium-male-narrator"),
        ("Esta Ã© uma apresentaÃ§Ã£o profissional importante.", "calm", "premium-male-professional")
    ]
    
    results = []
    
    for text, emotion, voice in test_cases:
        print(f"   Testando: {emotion} com {voice}")
        audio_path = tts.synthesize_speech_official(text, emotion, voice)
        
        if audio_path and os.path.exists(audio_path):
            file_size = os.path.getsize(audio_path) / 1024  # KB
            print(f"     âœ… Sucesso! Arquivo: {os.path.basename(audio_path)} ({file_size:.1f} KB)")
            results.append(True)
        else:
            print(f"     âŒ Falhou!")
            results.append(False)
    
    return all(results)

def test_emotion_synthesis():
    """Testa sÃ­ntese com anÃ¡lise automÃ¡tica de emoÃ§Ãµes"""
    print("\nğŸ­ Testando sÃ­ntese com anÃ¡lise automÃ¡tica...")
    
    tts = GoogleAIStudioTTSEnhanced()
    
    long_text = """
    Era uma vez, numa terra muito distante, um reino mÃ¡gico cheio de maravilhas! 
    Mas um dia, algo terrÃ­vel aconteceu... Uma sombra misteriosa cobriu toda a terra.
    Os habitantes ficaram muito tristes e assustados. 
    PorÃ©m, um jovem corajoso decidiu enfrentar o perigo!
    Com determinaÃ§Ã£o e esperanÃ§a, ele partiu em sua jornada Ã©pica.
    E no final, conseguiu salvar o reino! Todos ficaram felizes novamente!
    """
    
    print("   Texto longo com mÃºltiplas emoÃ§Ãµes...")
    audio_path = tts.synthesize_with_emotion_analysis(long_text, "premium-female-narrator")
    
    if audio_path and os.path.exists(audio_path):
        file_size = os.path.getsize(audio_path) / 1024
        print(f"     âœ… Sucesso! Arquivo combinado: {os.path.basename(audio_path)} ({file_size:.1f} KB)")
        return True
    else:
        print(f"     âŒ Falhou!")
        return False

def test_markup_features():
    """Testa recursos de markup oficial"""
    print("\nğŸ“ Testando recursos de markup...")
    
    tts = GoogleAIStudioTTSEnhanced()
    
    test_text = """
    AtenÃ§Ã£o! Este Ã© um teste importante. 
    Vamos fazer uma pausa... e continuar.
    Primeiro, segundo, terceiro ponto.
    Perfeito! Teste concluÃ­do com sucesso.
    """
    
    # Testa diferentes emoÃ§Ãµes com markup
    emotions = ['neutral', 'dramatic', 'enthusiastic', 'mysterious']
    results = []
    
    for emotion in emotions:
        markup = tts.create_official_markup(test_text, emotion)
        print(f"   Markup {emotion}:")
        print(f"     '{markup[:60]}...'" if len(markup) > 60 else f"     '{markup}'")
        
        # Verifica se contÃ©m tags de pausa
        has_pauses = '[pause' in markup
        results.append(has_pauses)
        print(f"     Pausas detectadas: {'âœ…' if has_pauses else 'âŒ'}")
    
    return any(results)

def run_comprehensive_test():
    """Executa todos os testes"""
    print("ğŸš€ INICIANDO TESTES ABRANGENTES DO GOOGLE CLOUD TTS ENHANCED")
    print("=" * 70)
    
    tests = [
        ("Listagem de Vozes", test_voice_listing),
        ("AnÃ¡lise de EmoÃ§Ãµes", test_emotion_analysis),
        ("RecomendaÃ§Ã£o de Voz", test_voice_recommendation),
        ("Recursos de Markup", test_markup_features),
        ("SÃ­ntese BÃ¡sica", test_basic_synthesis),
        ("SÃ­ntese com EmoÃ§Ãµes", test_emotion_synthesis)
    ]
    
    results = {}
    
    for test_name, test_func in tests:
        try:
            print(f"\nğŸ“‹ {test_name}:")
            results[test_name] = test_func()
        except Exception as e:
            print(f"âŒ Erro em {test_name}: {e}")
            results[test_name] = False
    
    # SumÃ¡rio final
    print("\n" + "=" * 70)
    print("ğŸ“Š RELATÃ“RIO FINAL DOS TESTES")
    print("=" * 70)
    
    passed = sum(results.values())
    total = len(results)
    
    for test_name, passed_test in results.items():
        status = "âœ… PASSOU" if passed_test else "âŒ FALHOU"
        print(f"{test_name:.<40} {status}")
    
    print(f"\nğŸ¯ RESUMO: {passed}/{total} testes passaram ({passed/total*100:.1f}%)")
    
    if passed == total:
        print("ğŸ‰ TODOS OS TESTES PASSARAM! Sistema estÃ¡ funcionando perfeitamente!")
    elif passed > total * 0.7:
        print("âœ… Maioria dos testes passou. Sistema estÃ¡ funcional.")
    else:
        print("âš ï¸ Muitos testes falharam. Verifique a configuraÃ§Ã£o.")
    
    return passed, total

if __name__ == "__main__":
    run_comprehensive_test()
